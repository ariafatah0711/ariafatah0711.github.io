<div id="imageModal" class="modal">
    <span class="close">&times;</span>
    <div class="modal-nav prev" id="prevBtn">&#10094;</div>
    <div class="modal-nav next" id="nextBtn">&#10095;</div>
    <img class="modal-content" id="modalImg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" onload="this.style.display='block'; this.nextElementSibling.style.display='none';">
    <div class="image-fallback" style="display:none;"></div>
    <!-- video element for project/video previews -->
    <video class="modal-content" id="modalVideo" controls style="display:none; background: black;"></video>
    <div class="modal-info" id="modalInfo">
        <div class="modal-title" id="modalTitle"></div>
        <div class="modal-description" id="modalDescription"></div>
        <div class="modal-counter" id="modalCounter"></div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
    var modal = document.getElementById("imageModal");
    var modalImg = document.getElementById("modalImg");
    var modalVideo = document.getElementById("modalVideo");
    var modalTitle = document.getElementById("modalTitle");
    var modalDescription = document.getElementById("modalDescription");
    var modalCounter = document.getElementById("modalCounter");
    var prevBtn = document.getElementById("prevBtn");
    var nextBtn = document.getElementById("nextBtn");
    var scrollPosition = 0;

    // Array untuk menyimpan data gambar
    var imageData = [];
    var currentIndex = 0;
    var isGalleryMode = false;

    // Event delegation untuk gallery items dan repo post images
    document.addEventListener('click', function(event) {
        // If click originates from a project item, ignore here (project modal handles it)
        if (event.target.closest('.project-item')) return;
        // Cek apakah yang diklik adalah gallery item
        var galleryItem = event.target.closest('.gallery-item');
        if (galleryItem) {
                // If gallery item contains a data-video attribute, open video modal instead
                var videoSrc = galleryItem.getAttribute('data-video') || galleryItem.dataset.video;
                var img = galleryItem.querySelector('.clickable-image');
                if (videoSrc && videoSrc !== 'undefined' && videoSrc !== '') {
                    var title = galleryItem.querySelector('.gallery-title') ? galleryItem.querySelector('.gallery-title').textContent : '';
                    var description = galleryItem.querySelector('.gallery-description') ? galleryItem.querySelector('.gallery-description').textContent : '';
                    openVideoModal(videoSrc, title, description);
                    return;
                }
                if (img) {
                    // Setup gallery mode dulu untuk mendapatkan data yang benar
                    setupGalleryMode();
                    // Cari index berdasarkan urutan yang terlihat saja
                    var visibleItems = document.querySelectorAll('.gallery-item:not([style*="display: none"])');
                    var index = Array.from(visibleItems).indexOf(galleryItem);
                    openModal(index, true);
                }
        }
        // Cek apakah yang diklik adalah gambar di repo post
        else if (event.target.classList.contains('clickable-image') && !event.target.closest('.gallery-item')) {
            setupRepoMode(event.target);
            openModal(0, false);
        }
    });

    function setupGalleryMode() {
        isGalleryMode = true;
        imageData = [];
        // Hanya ambil gallery items yang sedang visible (tidak tersembunyi oleh filter)
        var galleryItems = document.querySelectorAll('.gallery-item:not([style*="display: none"])');

        galleryItems.forEach(function(item) {
            var img = item.querySelector('.clickable-image');
            var title = item.querySelector('.gallery-title');
            var description = item.querySelector('.gallery-description');

            if (img) {
                imageData.push({
                    src: img.src,
                    title: title ? title.textContent : '',
                    description: description ? description.textContent : ''
                });
            }
        });
    }

    function setupRepoMode(img) {
        isGalleryMode = false;
        imageData = [{
            src: img.src,
            title: img.alt || '',
            description: ''
        }];
    }

    function openModal(index, showNav) {
        if (imageData.length === 0) return;

        currentIndex = index;
        scrollPosition = window.pageYOffset || document.documentElement.scrollTop;

        modal.style.display = "flex";
        updateModalContent();

        // Tampilkan/sembunyikan navigasi berdasarkan mode
        if (showNav && imageData.length > 1) {
            prevBtn.style.display = "block";
            nextBtn.style.display = "block";
        } else {
            prevBtn.style.display = "none";
            nextBtn.style.display = "none";
        }

        document.body.classList.add("modal-open");
        document.body.style.top = -scrollPosition + 'px';
    }

    function preloadAdjacent(index) {
        if (imageData.length <= 1) return;
        var nextIndex = (index + 1) % imageData.length;
        var prevIndex = (index - 1 + imageData.length) % imageData.length;
        var preloadNext = new Image();
        var preloadPrev = new Image();
        preloadNext.decoding = "async";
        preloadPrev.decoding = "async";
        preloadNext.src = imageData[nextIndex].src;
        preloadPrev.src = imageData[prevIndex].src;
    }

    function updateModalContent() {
        if (imageData[currentIndex]) {
            // ensure video is hidden when showing images
            if (modalVideo) {
                try { modalVideo.pause(); } catch(e){}
                modalVideo.style.display = 'none';
                modalVideo.removeAttribute('src');
            }
            modalImg.style.display = 'block';
            modalImg.src = imageData[currentIndex].src;
            modalTitle.textContent = imageData[currentIndex].title;
            modalDescription.textContent = imageData[currentIndex].description;

            // Hide modal-info if no title and no description
            var hasContent = imageData[currentIndex].title || imageData[currentIndex].description;
            var modalInfoEl = document.getElementById('modalInfo');
            if (modalInfoEl) {
                modalInfoEl.style.display = hasContent || (isGalleryMode && imageData.length > 1) ? 'flex' : 'none';
            }

            if (isGalleryMode && imageData.length > 1) {
                modalCounter.textContent = (currentIndex + 1) + ' / ' + imageData.length;
            } else {
                modalCounter.textContent = '';
            }

            // Preload gambar sebelumnya dan berikutnya untuk transisi mulus
            preloadAdjacent(currentIndex);
        }
    }

    function closeModal() {
        modal.style.display = "none";
        // stop and clear video if playing
        if (modalVideo) {
            try { modalVideo.pause(); } catch(e){}
            try { modalVideo.removeAttribute('src'); modalVideo.load(); } catch(e){}
            modalVideo.style.display = 'none';
        }
        document.body.classList.remove("modal-open");
        document.body.style.top = '';

        requestAnimationFrame(function() {
            window.scrollTo(0, scrollPosition);
        });
    }

    function showPrev() {
        if (isGalleryMode && imageData.length > 1) {
            currentIndex = (currentIndex - 1 + imageData.length) % imageData.length;
            updateModalContent();
        }
    }

    function showNext() {
        if (isGalleryMode && imageData.length > 1) {
            currentIndex = (currentIndex + 1) % imageData.length;
            updateModalContent();
        }
    }

    function openVideoModal(src, title, description) {
        // prepare
        scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        modal.style.display = 'flex';
        // hide image element
        modalImg.style.display = 'none';
        // set title/description
        modalTitle.textContent = title || '';
        modalDescription.textContent = description || '';
        // set counters and nav hidden for single video
        modalCounter.textContent = '';
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        // setup video
        if (modalVideo) {
            modalVideo.style.display = 'block';
            // allow both absolute and relative urls
            modalVideo.src = src;
            try { modalVideo.load(); } catch(e){}
            // try to autoplay muted to assist UX (may be blocked)
            try { modalVideo.play().catch(function(){}); } catch(e){}
        }
        document.body.classList.add("modal-open");
        document.body.style.top = -scrollPosition + 'px';
    }

    // Event listeners (scoped to this modal to avoid conflicts)
    var modalCloseBtn = modal.querySelector('.close');
    if (modalCloseBtn) modalCloseBtn.onclick = closeModal;
    prevBtn.onclick = showPrev;
    nextBtn.onclick = showNext;

    modal.onclick = function(event) {
        if (event.target === modal) {
            closeModal();
        }
    };

    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
        if (modal.style.display === 'flex') {
            switch(event.key) {
                case 'Escape':
                    closeModal();
                    break;
                case 'ArrowLeft':
                    showPrev();
                    break;
                case 'ArrowRight':
                    showNext();
                    break;
            }
        }
    });

    // Swipe gesture untuk mobile
    var touchStartX = 0;
    var touchStartY = 0;
    var touchMoved = false;
    var SWIPE_THRESHOLD = 40; // px
    modal.addEventListener('touchstart', function(e) {
        if (!e.touches || e.touches.length !== 1) return;
        touchMoved = false;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }, { passive: true });

    modal.addEventListener('touchmove', function(e) {
        if (!e.touches || e.touches.length !== 1) return;
        var dx = e.touches[0].clientX - touchStartX;
        var dy = e.touches[0].clientY - touchStartY;
        // Jika gerakan horizontal dominan, tandai sebagai swipe dan cegah scroll
        if (Math.abs(dx) > Math.abs(dy)) {
            touchMoved = true;
            e.preventDefault();
        }
    }, { passive: false });

    modal.addEventListener('touchend', function(e) {
        if (!touchMoved) return;
        var dx = (e.changedTouches && e.changedTouches[0] ? e.changedTouches[0].clientX : 0) - touchStartX;
        if (Math.abs(dx) > SWIPE_THRESHOLD) {
            if (dx < 0) {
                showNext();
            } else {
                showPrev();
            }
        }
    });

    // Listen untuk perubahan filter di gallery
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('filter-btn')) {
            // Jika modal sedang terbuka, update data gallery
            if (modal.style.display === 'flex' && isGalleryMode) {
                setTimeout(function() {
                    setupGalleryMode();
                    // Reset ke index 0 jika current index melebihi jumlah gambar yang tersedia
                    if (currentIndex >= imageData.length) {
                        currentIndex = 0;
                    }
                    updateModalContent();
                }, 100); // Delay sedikit untuk memastikan filter sudah diterapkan
            }
        }
    });
    });
</script>
